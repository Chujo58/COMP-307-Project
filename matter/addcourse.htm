<!-- Rachel Shi -->
<header class="staff-header">
  <div class="left-h">
    <a class="openbtn" id="openbtn" onclick="toggleStaffNav()">
      <img src="icons/pulsar_line_menu.png" />
    </a>
  </div>
  <div class="logo">Add/Remove Course</div>
</header>

<div class="container">
  <div id="staffdash-sidebar" class="sidebar">
    <!-- <div class="extra-sidebar"
      >
      <a class="closebtn" onclick="closeNav()">
        <img src="icons/pulsar_line_close.png" />
      </a> -->
      <a href="./index.php?Page=Dashboard">Main</a>
    <!-- </div> -->
    <a href="./index.php?Page=Calendar&session=true" id="aval"
      >Availabilities</a
    >
    <a id="staff_course_ln" href="./index.php?Page=StaffCourses">Courses</a>
    <a href="./index.php?Page=PendingRequests" id="pending">Pending Requests</a>
  </div>

  <div class="main-wrapper">
    <div class="main-dashboard-container">
      <form id="course-form" method="POST">
        <h2>Course Selection</h2>
        
        <div id="message"></div>

        <label for="course_tag">Course Tag</label>
        <input
          list="course_tags"
          name="course_tag"
          id="course_tag"
          required
          pattern="[A-Z]{1,4}"
          title="Course tags should be 4 letters. Example: COMP"
          minlength="4"
          maxlength="4"
          onkeypress="this.value = this.value.toUpperCase();"
          onchange="this.value = this.value.toUpperCase();"
          oninput="this.value = this.value.replace(/\s/g, '')"
        />
        <div id="course-tag-error-add"></div>

        <label for="course_id">Course ID</label>
        <input
          list="course_ids"
          name="course_id"
          id="course_id"
          required
          pattern="\d{3}([A-Z]\d)?"
          title="Enter 3 digits, or 3 digits followed by one uppercase letter (A-Z) and one digit. Examples: 123 or 123A4."
          maxlength="5"
          oninput="this.value = this.value.replace(/\s/g, '')"
        />
        <div id="course-id-error-add"></div>

        <label for="course_name">Course Name</label>
        <input
          list="course_name"
          name="course_name"
          id="course_name"
          pattern="[A-Za-z0-9]"
          title="Course names should be a short description."
        />

        <div class="buttons">
        <div class="addcourse-button" onclick="submitForm('add')">ADD</div>
        <div class="removecourse-button" onclick="submitForm('remove')">REMOVE</div>
        </div>
      </div>
      </form>
      
    </div>
  </div>

  <script>
    function toggleStaffNav(){
      if (document.getElementById("staffdash-sidebar").style.display == 'flex'){
        document.getElementById("staffdash-sidebar").style.display = 'none';
        document.getElementById('openbtn').innerHTML = '<img src="icons/pulsar_line_menu.png">';
        return;
      } else {
        document.getElementById("staffdash-sidebar").style.display = 'flex';
        document.getElementById('openbtn').innerHTML = '<img src="icons/pulsar_line_close.png">';
      }
    }

    function openNav() {
      document.getElementById("staffdash-sidebar").style.display = "flex";
    }

    function closeNav() {
      document.getElementById("staffdash-sidebar").style.display = "none";
    }

    function submitForm(action) {
      var courseTag = document.getElementById("course_tag").value;
      var courseId = document.getElementById("course_id").value;
      var courseName = document.getElementById("course_name").value;

      var messageDiv = document.getElementById("message");
      messageDiv.innerHTML = "";

      const patternName = /^[A-Z]{1,4}$/;
      if (!patternName.test(courseTag) && courseTag != ''){
          document.getElementById('course-tag-error-add').style.color = 'red';
          document.getElementById('course-tag-error-add').innerHTML = 'Invalid format. Should match 3 digits, or 3 digits followed by one uppercase letter and one digit.';   
          return;
      }
      document.getElementById('course-tag-error-add').innerHTML = '';

      const patternID = /^\d{3}([A-Z]\d)?$/;
      if (!patternID.test(courseId) && courseId != ''){
          document.getElementById('course-id-error-add').style.color = 'red';
          document.getElementById('course-id-error-add').innerHTML = 'Invalid format. Should match 3 digits, or 3 digits followed by one uppercase letter and one digit.';   
          return;
      }
      document.getElementById('course-id-error-add').innerHTML = '';

      if (action == 'add'){
          if (!courseTag || !courseId || !courseName) {
            messageDiv.style.color = "red";
            messageDiv.innerHTML = "Please fill in all fields.";
            return;
          }
      }
      if (action == 'remove'){
        if (!courseTag || !courseId) {
            messageDiv.style.color = "red";
            messageDiv.innerHTML = "Please fill in all fields.";
            return;
          }
      }

      var formData = new FormData();
      formData.append("action", action);
      formData.append("course_tag", courseTag);
      formData.append("course_id", courseId);
      formData.append("course_name", courseName);

      var xhr = new XMLHttpRequest();
      xhr.open("POST", "php/addcourse.php", true);

      xhr.onreadystatechange = function () {
        if (xhr.readyState == 4) {
          if (xhr.status == 200) {
            var response = xhr.responseText;
            if (response.includes("success")) {
              messageDiv.style.color = "green";
              messageDiv.innerHTML =
                "Course " +
                (action === "add" ? "added" : "removed") +
                " successfully.";
            } else {
              messageDiv.style.color = "red";
              messageDiv.innerHTML = response;
            }
            setTimeout(function() {
                document.getElementById('staff_course_ln').click();
            }, 500);
          } else {
            messageDiv.style.color = "red";
            messageDiv.innerHTML =
              "An error occurred while processing the request.";
          }
        }
      };

      xhr.send(formData);
    }
  </script>
</div>
